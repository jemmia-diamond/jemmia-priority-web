<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-S7Q7M2B9DJ"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-S7Q7M2B9DJ");
    </script>
    <!-- Mobile Specific Metas -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, viewport-fit=cover"
    />
    <title>Jemmia Priority - New Card</title>
    <!-- Favicon and Touch Icons  -->
    <link rel="shortcut icon" href="images/logo.png" />
    <link rel="apple-touch-icon-precomposed" href="images/logo.png" />
    <!-- Font -->
    <link rel="stylesheet" href="fonts/fonts.css" />
    <!-- Icons -->
    <link rel="stylesheet" href="fonts/icons-alipay.css" />
    <link rel="stylesheet" href="styles/bootstrap.css" />

    <link rel="stylesheet" type="text/css" href="styles/styles.css" />
    <link
      rel="manifest"
      href="_manifest.json"
      data-pwa-version="set_in_manifest_and_pwa_js"
    />
    <link
      rel="apple-touch-icon"
      sizes="192x192"
      href="app/icon/icon-192x192.jpg"
    />
  </head>

  <body class="" style="height: 100vh">
    <!-- preloade -->

    <!-- /preload -->
    <div class="header is-fixed">
      <div class="tf-container">
        <div
          class="tf-statusbar d-flex justify-content-center align-items-center"
        >
          <a style="outline: none" href="#" class="back-btn">
            <i class="icon-left"></i>
          </a>
          <h3>Thêm thông tin thẻ</h3>
          <!-- <a href="#" id="btn-popup-up" class="action-right"><i class="icon icon-filter"></i> </a> -->
        </div>
      </div>
    </div>

    <div
      class="tf-container d-flex flex-column justify-content-between"
      style="height: 90%; padding-top: 80px"
    >
      <form class="tf-form">
        <!-- <h2 class="py-4"></h2> -->
        <div class="group-input position-relative">
          <label>Số tài khoản</label>
          <input
            type="number"
            placeholder="Số tài khoản"
            id="number_bank"
            inputmode="numeric"
            min="11"
            max="11"
          />
          <p class="position-absolute" style="top: 11px; right: 10px">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              fill="currentColor"
              class="bi bi-credit-card-2-back-fill"
              viewBox="0 0 16 16"
            >
              <path
                d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v5H0zm11.5 1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h2a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zM0 11v1a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-1z"
              />
            </svg>
          </p>
        </div>
        <div class="group-input position-relative">
          <label>Tên chủ tài khoản</label>
          <input type="text" placeholder="Tên chủ tài khoản" id="name_card" />
        </div>
        <div class="group-input">
          <label>Ngân hàng</label>
          <input type="text" placeholder="Ngân hàng" id="bank" />
        </div>

        <div class="row gap-4 mb-2">
          <div class="col d-flex flex-column gap-3">
            <div class="" id="font"></div>
            <a
              style="
                outline: none;
                font-size: 16px;
                height: 40px;
                color: #003a40;
                font-weight: 600;
              "
              href="86_uploadFont.html"
              class="text-center mb-3"
            >
              <p>Cập nhật ảnh CCCD</p>
              <p>(Mặt trước)</p>
            </a>
          </div>
          <div class="col d-flex flex-column gap-3">
            <div class="" id="back"></div>
            <a
              style="
                outline: none;
                font-size: 16px;
                height: 40px;
                color: #003a40;
                font-weight: 600;
              "
              href="87_uploadBack.html"
              class="text-center mb-3"
            >
              <p>Cập nhật ảnh CCCD</p>
              <p>(Mặt sau)</p>
            </a>
          </div>
        </div>

        <div class="">
          <a
            style="outline: none"
            type="submit"
            id="saveCard"
            class="tf-btn accent large"
            style="border: none; color: white"
            >Lưu</a
          >
          <label for="" id="err"></label>
        </div>
      </form>
    </div>

    <div class="tf-panel up">
      <div class="panel_overlay"></div>
      <div class="panel-box panel-up wrap-panel-clear panel-change-profile">
        <div class="heading">
          <a href="#">Show Profile Picture</a>
          <a href="#">New Photo Shoot</a>
          <a href="#">Select Photo Form Device</a>
          <a href="#">Choose An Existing Avatar</a>
        </div>
        <div class="bottom">
          <a class="clear-panel" href="#">Dismiss</a>
        </div>
      </div>
    </div>

    <script type="text/javascript" src="javascript/bootstrap.min.js"></script>
    <script type="text/javascript" src="javascript/jquery.min.js"></script>
    <script type="text/javascript" src="javascript/main.js"></script>
    <script>
      const user_id = JSON.parse(localStorage.getItem("user"));
      const tokens = JSON.parse(localStorage.getItem("accessToken"));
      if (!user_id || !tokens) {
        window.location.assign("/04_login.html");
      }
    </script>
    <script>
      const Save = document.getElementById("saveCard");
      const verifyCard = JSON.parse(localStorage.getItem("NewCard"));
      const number_bank = document.getElementById("number_bank");
      const name_card = document.getElementById("name_card");
      const bank = document.getElementById("bank");
      const user = JSON.parse(localStorage.getItem("user"));
      const token = JSON.parse(localStorage.getItem("accessToken"));

      const HEADER = {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + token,
        },
      };
      async function getUser() {
        const loadUser = await fetch(
          `https://priority-api.jemmia.vn/user/${user_id.id}`,
          HEADER
        ).then((e) => {
          e.json().then((items) => {
            const regex =
              /[áàảãạăắằẳẵặâấầẩẫậđéèẻẽẹêếềểễệíìỉĩịóòỏõọôốồổỗộơớờởỡợúùủũụưứừửữựýỳỷỹỵ]/g;

            number_bank.value = items.bankingAccount.number
              ? items.bankingAccount.number
              : "";

            name_card.value = `${items.bankingAccount.name ?? ""}`;
            bank.value = items.bankingAccount.bankName
              ? items.bankingAccount.bankName
              : "";
            Save.innerText = "Cập Nhật Số Tài Khoản";

            if (!items.frontIDCardImageUrl) {
              const font = document.getElementById("font");
              const dragImage = document.createElement("a");
              dragImage.href = "/86_uploadFont.html";
              dragImage.innerText = "Cập nhật ảnh CCCD (Mặt trước)";
              dragImage.style.width = "100%";
              dragImage.style.height = "300px";
              dragImage.style.border = "1px dashed black";
              dragImage.style.backgroundColor = "rgba(0, 58, 64, 0.3)";
              dragImage.classList.add(
                "d-flex",
                "justify-content-center",
                "align-items-center",
                "fs-7",
                "fw-bolder"
              );
              font.appendChild(dragImage);
            } else {
              const font = document.getElementById("font");
              const dragImage = document.createElement("img");
              dragImage.src = items.frontIDCardImageUrl;
              dragImage.style.width = "100%";
              dragImage.style.height = "300px";
              dragImage.style.objectFit = "contain";
              dragImage.style.borderRadius = "16px";
              // dragImage.classList.add(
              //   "d-flex",
              //   "justify-content-center",
              //   "align-items-center",
              //   "fs-7",
              //   "fw-bolder"
              // );
              // dragImage.style.border = "1px dashed black";
              // dragImage.style.backgroundColor = "rgba(0, 58, 64, 0.3)";

              font.appendChild(dragImage);
            }
            if (!items.backIDCardImageUrl) {
              const back = document.getElementById("back");
              const dragImage = document.createElement("a");
              dragImage.href = "/87_uploadBack.html";
              dragImage.innerText = "Cập nhật ảnh CCCD (Mặt sau)";
              dragImage.style.width = "100%";
              dragImage.style.height = "300px";
              dragImage.classList.add(
                "d-flex",
                "justify-content-center",
                "align-items-center",
                "fs-7",
                "fw-bolder"
              );
              dragImage.style.border = "1px dashed black";
              dragImage.style.backgroundColor = "rgba(0, 58, 64, 0.3)";

              back.appendChild(dragImage);
            } else {
              const back = document.getElementById("back");
              const dragImage = document.createElement("img");
              dragImage.src = items.backIDCardImageUrl;
              dragImage.style.width = "100%";
              dragImage.style.height = "300px";
              dragImage.style.objectFit = "contain";
              dragImage.style.borderRadius = "16px";
              // dragImage.classList.add(
              //   "d-flex",
              //   "justify-content-center",
              //   "align-items-center",
              //   "fs-7",
              //   "fw-bolder"
              // );
              // dragImage.style.border = "1px dashed black";
              // dragImage.style.backgroundColor = "rgba(0, 58, 64, 0.3)";

              back.appendChild(dragImage);
            }
          });
        });
      }

      getUser();

      async function addNewCard() {
        const fullName = `${user.name}`;
        const payload = {
          bankingAccount: {
            number: number_bank.value,
            bankName: bank.value,
            name: name_card.value,
          },
        };

        const HEADER_CONFIGs = {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify(payload),
        };

        if (
          number_bank.value &&
          name_card.value &&
          name_card.value.trim() !== "" &&
          bank.value
          // && name_card.value.toUpperCase() == textWithoutMarks
        ) {
          const fetchs = await fetch(
            `https://priority-api.jemmia.vn/user/${user_id.id}`,
            HEADER_CONFIGs
          ).then((e) =>
            e.json().then((items) => {
              window.location.assign("/69_profile.html");
            })
          );
        } else {
          const err = document.getElementById("err");

          err.innerText = !number_bank.value
            ? "Vui lòng nhập số tài khoản"
            : !name_card.value
            ? "Vui lòng nhập tên"
            : !bank.value
            ? "Vui lòng nhập tên ngân hàng"
            : name_card.value.trim() == ""
            ? "Vui lòng nhập Tên chủ tài khoản"
            : !name_card.value
            ? "Vui lòng điền đầy đủ thông tin"
            : "Thêm Tài Khoản Thất Bại";

          err.style.color = "red";
          Save.style.backgroundColor = "red";
        }
      }
      Save.addEventListener("click", addNewCard);
    </script>
  </body>
</html>
